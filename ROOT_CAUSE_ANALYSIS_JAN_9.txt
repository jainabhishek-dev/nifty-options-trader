================================================================================
ROOT CAUSE ANALYSIS: Trading Stopped After 16 Positions
================================================================================
Date: January 9, 2026
Issue: No more orders coming in after 16 positions (32 orders)

================================================================================
üéØ ROOT CAUSE IDENTIFIED
================================================================================

MEMORY LEAK: Closed positions are NOT removed from self.positions dictionary

LOCATION: virtual_order_executor.py, _close_matching_position() method (lines 685-764)

THE BUG:
--------
When a position is closed:
1. Position marked as closed: target_position.is_closed = True ‚úÖ
2. Quantity set to 0: target_position.quantity = 0 ‚úÖ
3. Database updated: is_open = False ‚úÖ
4. BUT: Position NOT removed from self.positions dict ‚ùå

CONSEQUENCE:
------------
- Closed positions accumulate in memory
- Position limit check: if len(self.positions) >= self.max_positions
- Counts ALL positions (open + closed) in memory
- When memory has 50+ positions (even if closed), new BUY orders blocked

YOUR SCENARIO:
--------------
- Created 16 positions (16 BUY orders)
- Closed all 16 positions (16 SELL orders)
- Memory still has 16 positions in self.positions dict
- Next round: Create 16 more, close 16 more
- Memory now has 32 positions
- Continue until memory reaches 50+ positions
- THEN: "Maximum positions limit reached" message
- No more BUY orders allowed

================================================================================
EVIDENCE IN CODE
================================================================================

1. Position Limit Check (line 391):
   ```python
   if len(self.positions) >= self.max_positions:
       print("Maximum positions limit reached")
       return False
   ```
   
   This checks: len(self.positions) - counts ALL positions in dict
   Not checking: is_closed status or is_open in database

2. Position Close Logic (line 708):
   ```python
   target_position.is_closed = True
   target_position.quantity = 0
   # ... database update ...
   # ‚ùå MISSING: del self.positions[target_position_key]
   ```
   
   The position is updated but NOT removed from dictionary

3. No Cleanup Code:
   - Searched entire codebase
   - NO code that does: del self.positions[key]
   - NO code that does: self.positions.pop(key)
   - Closed positions never leave memory

================================================================================
VERIFICATION STEPS
================================================================================

To confirm this is your issue, check:

1. Application logs for this message:
   "Maximum positions limit reached"
   
2. Count positions in memory:
   - If you have access to running instance
   - Print: len(order_executor.positions)
   - Compare to database open positions
   
3. Database query:
   ```sql
   SELECT COUNT(*) FROM positions 
   WHERE is_open = true 
   AND trading_mode = 'paper';
   ```
   
   If database shows < 50 open but trading stopped, confirms memory leak

================================================================================
THE FIX (AWAITING YOUR APPROVAL)
================================================================================

OPTION 1: Remove closed positions from memory (RECOMMENDED)
------------------------------------------------------------
In _close_matching_position() method, after closing:

```python
# After database update, remove from memory
if target_position_key in self.positions:
    del self.positions[target_position_key]
    print(f"üßπ Position removed from memory: {target_position_key}")
```

PROS:
‚úÖ Fixes memory leak
‚úÖ Accurate position count
‚úÖ No artificial limit due to closed positions
‚úÖ Better memory management

CONS:
‚ö†Ô∏è Closed positions not queryable in memory (still in database)


OPTION 2: Check only OPEN positions in limit
---------------------------------------------
In place_order() method, change line 391:

```python
# OLD: if len(self.positions) >= self.max_positions:
# NEW:
open_positions = sum(1 for p in self.positions.values() 
                     if not getattr(p, 'is_closed', False))
if open_positions >= self.max_positions:
    print(f"Maximum open positions limit reached ({open_positions}/{self.max_positions})")
    return False
```

PROS:
‚úÖ Closed positions stay in memory for queries
‚úÖ Only open positions count toward limit

CONS:
‚ö†Ô∏è Memory still grows (though slower)
‚ö†Ô∏è More complex check


OPTION 3: Hybrid approach (BEST)
---------------------------------
1. Remove from memory when closed (Option 1)
2. Keep position recovery from database on startup
3. Add periodic cleanup of old closed positions

PROS:
‚úÖ Clean memory
‚úÖ Accurate limits
‚úÖ Can still query recent positions via database

================================================================================
ADDITIONAL FINDINGS
================================================================================

1. Daily Trade Limit: Not the issue
   - max_daily_trades = 100
   - Your 32 orders << 100
   - This limit was not reached

2. Position Limit: Was set correctly
   - max_positions = 50 (recently increased from 10)
   - But counting closed positions due to memory leak

3. Trade Count Logic: Working correctly
   - Increments once per place_order() call
   - Both BUY and SELL orders counted

================================================================================
IMPACT ASSESSMENT
================================================================================

CURRENT STATE:
- Trading stops unpredictably when memory accumulates 50+ positions
- Happens faster with frequent trading (scalping strategy)
- Database shows fewer open positions than limit suggests
- Confusing because "50 positions" seems like plenty

AFTER FIX:
- Only open positions count toward limit
- Can sustain continuous trading as designed
- Memory usage stable
- Position limit behaves as expected

================================================================================
RECOMMENDATION
================================================================================

IMMEDIATE:
1. Confirm diagnosis by checking logs for "Maximum positions limit reached"
2. Count current memory positions vs database open positions
3. Approve one of the three fix options

PREFERRED FIX: Option 1 (Remove from memory)
- Simple, clean, effective
- Matches expected behavior
- No ongoing memory growth

DEPLOYMENT:
- Apply fix to virtual_order_executor.py
- Test with few positions first
- Deploy during non-market hours
- Monitor position count in memory

================================================================================
TESTING PLAN (After fix approval)
================================================================================

1. Unit test: Verify closed positions removed
2. Integration test: Create 60+ positions (exceeds old limit)
3. Memory test: Confirm dict size stays reasonable
4. Production: Monitor for "Maximum positions" message

================================================================================
