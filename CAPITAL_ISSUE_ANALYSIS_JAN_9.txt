================================================================================
CAPITAL ISSUE ANALYSIS - January 9, 2026
================================================================================

SYMPTOM: "Insufficient capital. Required: â‚¹6,185, Available: â‚¹92"

================================================================================
ðŸŽ¯ ROOT CAUSE IDENTIFIED: CAPITAL NOT RELEASED ON POSITION CLOSE
================================================================================

CRITICAL BUGS:
1. Capital is LOCKED when opening positions (BUY)
2. Capital is NEVER RELEASED when closing positions (SELL)
3. After ~30 trades, all capital is locked in closed positions

THE FLOW:
---------

Opening Position (BUY):
  Line 583-584:
  ```python
  self.available_capital -= total_cost  # Capital locked âœ…
  self.used_margin += total_cost        # Margin increased âœ…
  ```

Closing Position (SELL):
  Line 685-764 (_close_matching_position):
  ```python
  target_position.is_closed = True      # Position marked closed âœ…
  # âŒ MISSING: self.available_capital += released_capital
  # âŒ MISSING: self.used_margin -= released_capital
  ```

Result:
  - Capital locked on BUY, never released on SELL
  - All â‚¹200,000 initial capital gradually becomes unavailable
  - Eventually: available_capital = â‚¹92 (nearly exhausted)

================================================================================
YOUR SCENARIO
================================================================================

Initial state:
  - available_capital: â‚¹200,000
  - used_margin: â‚¹0

After 16 positions (16 BUY + 16 SELL):
  - 16 BUY orders locked: ~â‚¹6,185 each = â‚¹98,960 total
  - 16 SELL orders: âŒ No capital released
  - available_capital: â‚¹200,000 - â‚¹98,960 = â‚¹101,040

After more trading rounds:
  - Continue locking capital on each BUY
  - NEVER release on SELL
  - Eventually: available_capital = â‚¹92 (almost nothing left)

Latest order attempt:
  - Required: â‚¹95.15 Ã— 65 = â‚¹6,185
  - Available: â‚¹92
  - Result: "Insufficient capital" âŒ

================================================================================
WHY THIS WASN'T NOTICED BEFORE
================================================================================

1. Initially had plenty of capital (â‚¹200,000)
2. First ~30 orders worked fine
3. Capital gradually depleted with each trade
4. Only manifested after sustained trading
5. Combined with position memory leak (previous issue)

TWO SEPARATE BUGS:
  Bug 1: Positions not removed from memory â†’ Hit position limit
  Bug 2: Capital not released â†’ Hit capital limit

Both prevent trading after ~30-50 trades!

================================================================================
EVIDENCE IN YOUR LOGS
================================================================================

```
âœ… Got LTP for NIFTY2611325700PE: â‚¹95.15
Insufficient capital. Required: â‚¹6,185, Available: â‚¹92
```

This happens at line 407 in virtual_order_executor.py:
```python
if required_capital > self.available_capital:
    print(f"Insufficient capital. Required: â‚¹{required_capital:,.0f}, Available: â‚¹{self.available_capital:,.0f}")
```

Available capital = â‚¹92 means:
  - Started with â‚¹200,000
  - Locked â‚¹199,908 in previous trades
  - Never released any capital on SELL
  - Only â‚¹92 remaining

================================================================================
THE FIX (AWAITING YOUR APPROVAL)
================================================================================

In _close_matching_position() method, AFTER closing position:

```python
# After line 719 (marking position as closed)

# CRITICAL FIX: Release capital back when position closes
# Calculate the capital that was locked for this position
original_quantity = target_position.metadata.get('original_quantity', trade.quantity)
locked_capital = (target_position.entry_price * original_quantity) + self.brokerage_per_lot

# Release capital
self.available_capital += locked_capital
self.used_margin -= locked_capital

print(f"ðŸ’° Capital released: â‚¹{locked_capital:,.0f} (Available: â‚¹{self.available_capital:,.0f})")
```

PLACEMENT: Insert after line 719, before database update

================================================================================
ADDITIONAL CONSIDERATIONS
================================================================================

1. P&L Handling:
   - Released capital should be base capital only
   - P&L is separate (already calculated and tracked)
   - Don't double-count P&L in capital release

2. For SELL orders:
   - SELL order itself locks capital (for the SELL)
   - But closing the position releases the original BUY capital
   - Net effect: Capital should increase after full cycle

3. Correct Formula:
   ```python
   # What was locked on BUY:
   locked = (entry_price Ã— quantity) + fees
   
   # Release that amount (not the current price):
   available_capital += locked
   ```

================================================================================
IMPACT ASSESSMENT
================================================================================

CURRENT STATE:
  âœ— Capital depletes with each trade
  âœ— System unusable after ~30 trades
  âœ— Requires manual restart to "refill" capital
  âœ— No real-time capital tracking

AFTER FIX:
  âœ“ Capital cycles properly (lock â†’ release)
  âœ“ Can trade continuously
  âœ“ available_capital stays near initial_capital (Â± P&L)
  âœ“ Accurate capital tracking

================================================================================
VERIFICATION STEPS
================================================================================

After fix, verify:

1. Start with â‚¹200,000
2. Open position: capital decreases by cost
3. Close position: capital increases by locked amount
4. After 100 trades: available_capital â‰ˆ â‚¹200,000 Â± total P&L

Calculation check:
  available_capital + used_margin = initial_capital + total_realized_pnl

================================================================================
COMBINED FIX NEEDED
================================================================================

You need BOTH fixes:

Fix 1: Position Memory Leak (previous issue)
  - Remove closed positions from self.positions dict
  - Prevents "Maximum positions limit reached"

Fix 2: Capital Release (this issue)  
  - Release capital when closing positions
  - Prevents "Insufficient capital"

Both are in _close_matching_position() method!

================================================================================
RECOMMENDATION
================================================================================

IMMEDIATE:
  1. Approve both fixes together
  2. They should be applied in same method
  3. Test with small capital first (â‚¹10,000)

COMBINED FIX CODE:
```python
# In _close_matching_position(), after line 719:

# CRITICAL FIX 1: Release locked capital
original_quantity = target_position.metadata.get('original_quantity', trade.quantity)
locked_capital = (target_position.entry_price * original_quantity) + self.brokerage_per_lot
self.available_capital += locked_capital
self.used_margin -= locked_capital
print(f"ðŸ’° Capital released: â‚¹{locked_capital:,.0f} (Available: â‚¹{self.available_capital:,.0f})")

# ... (existing database update code) ...

# CRITICAL FIX 2: Remove closed position from memory (after DB update)
if target_position_key in self.positions:
    del self.positions[target_position_key]
    print(f"ðŸ§¹ Position removed from memory: {target_position_key}")
```

DEPLOYMENT:
  - Apply during non-market hours
  - Monitor capital tracking closely
  - Verify with dashboard/logs

================================================================================
