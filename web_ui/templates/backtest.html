{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Backtest Configuration -->
    <div class="col-md-8">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-chart-line text-info"></i> Strategy Backtesting</h3>
                <button class="btn btn-primary btn-sm" onclick="loadAvailableStrategies()">
                    <i class="fas fa-sync-alt"></i> Refresh Strategies
                </button>
            </div>
            
            <!-- Real Data Notice -->
            <div class="alert alert-success" role="alert">
                <i class="fas fa-database"></i> <strong>Real Historical Data:</strong> 
                This backtesting engine uses authentic market data from Kite Connect API. 
                Results reflect actual market conditions and price movements.
            </div>
            
            <!-- Backtest Form -->
            <form id="backtestForm" onsubmit="runBacktest(event)">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="strategySelect" class="form-label">Strategy</label>
                        <select class="form-control" id="strategySelect" required>
                            <option value="">Select Strategy...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="initialCapital" class="form-label">Initial Capital (â‚¹)</label>
                        <input type="number" class="form-control" id="initialCapital" 
                               value="100000" min="1000" step="1000" required>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="col-md-6">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success" id="runBacktestBtn">
                        <i class="fas fa-play"></i> Run Backtest
                    </button>
                </div>
            </form>
        </div>

        <!-- Backtest Results -->
        <div class="metric-card" id="resultsContainer" style="display: none;">
            <h4><i class="fas fa-chart-bar text-success"></i> Backtest Results</h4>
            <div id="backtestResults" class="mt-3">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Backtest Status & Quick Info -->
    <div class="col-md-4">
        <!-- Quick Stats -->
        <div class="metric-card status-card">
            <h4><i class="fas fa-tachometer-alt text-primary"></i> Quick Stats</h4>
            <div class="status-grid">
                <div class="status-item">
                    <span>Available Strategies:</span>
                    <span id="strategyCount" class="text-primary">0</span>
                </div>
                <div class="status-item">
                    <span>Last Backtest:</span>
                    <span id="lastBacktest" class="text-secondary">Never</span>
                </div>
                <div class="status-item">
                    <span>Status:</span>
                    <span id="backtestStatus" class="text-secondary">Ready</span>
                </div>
            </div>
        </div>

        <!-- Performance Summary -->
        <div class="metric-card" id="performanceSummary" style="display: none;">
            <h5><i class="fas fa-trophy text-warning"></i> Performance Summary</h5>
            <div id="performanceMetrics" class="mt-3">
                <!-- Performance metrics will be populated here -->
            </div>
        </div>

        <!-- Recent Backtests History -->
        <div class="metric-card">
            <h5><i class="fas fa-history text-info"></i> Recent Backtests</h5>
            <div id="recentBacktests" class="mt-3">
                <p class="text-muted text-center py-3">No recent backtests</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                <h5>Running Backtest...</h5>
                <p class="text-muted">This may take a few minutes</p>
            </div>
        </div>
    </div>
</div>

<script>
let availableStrategies = [];

// Initialize page
$(document).ready(function() {
    // Set default dates (last 30 days)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    $('#startDate').val(startDate.toISOString().split('T')[0]);
    $('#endDate').val(endDate.toISOString().split('T')[0]);
    
    loadAvailableStrategies();
});

function loadAvailableStrategies() {
    fetch('/api/strategies')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableStrategies = data.strategies || [];
                populateStrategySelect();
                $('#strategyCount').text(availableStrategies.length);
            } else {
                console.error('Error loading strategies:', data.error);
                showAlert('error', 'Failed to load strategies: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error loading strategies:', error);
            showAlert('error', 'Network error loading strategies');
        });
}

function populateStrategySelect() {
    const select = $('#strategySelect');
    select.empty();
    select.append('<option value="">Select Strategy...</option>');
    
    availableStrategies.forEach(strategy => {
        select.append(`<option value="${strategy.name}">${strategy.name} - ${strategy.description || 'No description'}</option>`);
    });
}

function runBacktest(event) {
    event.preventDefault();
    
    const formData = {
        strategy_name: $('#strategySelect').val(),
        start_date: $('#startDate').val(),
        end_date: $('#endDate').val(),
        initial_capital: parseInt($('#initialCapital').val())
    };
    
    if (!formData.strategy_name) {
        showAlert('warning', 'Please select a strategy');
        return;
    }
    
    // Show loading modal
    $('#loadingModal').modal('show');
    $('#backtestStatus').text('Running...');
    $('#runBacktestBtn').prop('disabled', true);
    
    fetch('/api/strategies/backtest', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        $('#loadingModal').modal('hide');
        $('#runBacktestBtn').prop('disabled', false);
        $('#backtestStatus').text('Ready');
        
        if (data.success) {
            displayBacktestResults(data.result);
            $('#lastBacktest').text(new Date().toLocaleString());
            showAlert('success', 'Backtest completed successfully');
        } else {
            console.error('Backtest error:', data.error);
            showAlert('error', 'Backtest failed: ' + data.error);
        }
    })
    .catch(error => {
        $('#loadingModal').modal('hide');
        $('#runBacktestBtn').prop('disabled', false);
        $('#backtestStatus').text('Error');
        console.error('Backtest error:', error);
        showAlert('error', 'Network error during backtest');
    });
}

function displayBacktestResults(result) {
    if (!result) {
        return;
    }
    
    // Show results container
    $('#resultsContainer').show();
    
    // Display main results
    const resultsHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6>Portfolio Performance</h6>
                <table class="table table-sm">
                    <tr><td>Total Return:</td><td class="text-${(result.total_return || 0) >= 0 ? 'success' : 'danger'}">${((result.total_return || 0) * 100).toFixed(2)}%</td></tr>
                    <tr><td>Sharpe Ratio:</td><td>${(result.sharpe_ratio || 0).toFixed(3)}</td></tr>
                    <tr><td>Max Drawdown:</td><td class="text-danger">${((result.max_drawdown || 0) * 100).toFixed(2)}%</td></tr>
                    <tr><td>Win Rate:</td><td>${((result.win_rate || 0) * 100).toFixed(1)}%</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Trading Statistics</h6>
                <table class="table table-sm">
                    <tr><td>Total Trades:</td><td>${result.total_trades || 0}</td></tr>
                    <tr><td>Profitable:</td><td class="text-success">${result.profitable_trades || 0}</td></tr>
                    <tr><td>Losses:</td><td class="text-danger">${result.loss_trades || 0}</td></tr>
                    <tr><td>Avg Return:</td><td>${((result.avg_return || 0) * 100).toFixed(2)}%</td></tr>
                </table>
            </div>
        </div>
    `;
    
    $('#backtestResults').html(resultsHtml);
    
    // Show performance summary
    $('#performanceSummary').show();
    const performanceHtml = `
        <div class="text-center">
            <div class="mb-2">
                <span class="badge bg-${(result.total_return || 0) >= 0 ? 'success' : 'danger'} fs-6">
                    ${((result.total_return || 0) * 100).toFixed(2)}% Return
                </span>
            </div>
            <small class="text-muted">Final Portfolio Value: â‚¹${(result.final_portfolio_value || 0).toLocaleString()}</small>
        </div>
    `;
    
    $('#performanceMetrics').html(performanceHtml);
}

function showAlert(type, message) {
    // Create alert element
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert alert at top of page
    $('.container-fluid').prepend(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %}