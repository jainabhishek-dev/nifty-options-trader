{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Orders & Trade History -->
    <div class="col-md-8">
        <div class="metric-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-exchange-alt text-info"></i> Trade History</h3>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="refreshTrades()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportTrades()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            
            <!-- Filter Controls -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <select class="form-control form-control-sm" id="statusFilter" onchange="filterTrades()">
                        <option value="">All Status</option>
                        <option value="COMPLETE">Completed</option>
                        <option value="OPEN">Open</option>
                        <option value="CANCELLED">Cancelled</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-control form-control-sm" id="typeFilter" onchange="filterTrades()">
                        <option value="">All Types</option>
                        <option value="BUY">Buy</option>
                        <option value="SELL">Sell</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="date" class="form-control form-control-sm" id="dateFilter" onchange="filterTrades()">
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="symbolFilter" 
                           placeholder="Symbol..." onkeyup="filterTrades()">
                </div>
            </div>
            
            <!-- Orders Table -->
            <div class="table-responsive">
                <table class="table table-hover" id="tradesTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>P&L</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        {% if orders %}
                            {% for order in orders %}
                            <tr>
                                <td>{{ order.order_timestamp.strftime('%H:%M:%S') if order.order_timestamp else 'N/A' }}</td>
                                <td>{{ order.tradingsymbol or 'N/A' }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if order.transaction_type == 'BUY' else 'danger' }}">
                                        {{ order.transaction_type or 'N/A' }}
                                    </span>
                                </td>
                                <td>{{ order.quantity or 0 }}</td>
                                <td>₹{{ "%.2f"|format(order.price or 0) }}</td>
                                <td>
                                    <span class="badge bg-{% if order.status == 'COMPLETE' %}success{% elif order.status == 'OPEN' %}warning{% elif order.status == 'CANCELLED' %}secondary{% else %}danger{% endif %}">
                                        {{ order.status or 'UNKNOWN' }}
                                    </span>
                                </td>
                                <td class="{% if (order.pnl or 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ₹{{ "%.2f"|format(order.pnl or 0) }}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewOrderDetails('{{ order.order_id }}')" 
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-2"></i>
                                <p class="text-muted">No trades found</p>
                                <small class="text-muted">Start trading to see your order history here</small>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Trading Statistics -->
    <div class="col-md-4">
        <!-- Today's Summary -->
        <div class="metric-card status-card">
            <h4><i class="fas fa-chart-line text-success"></i> Today's Summary</h4>
            <div class="status-grid">
                <div class="status-item">
                    <span>Total Trades:</span>
                    <span id="todayTrades" class="text-primary">0</span>
                </div>
                <div class="status-item">
                    <span>P&L:</span>
                    <span id="todayPnL" class="text-secondary">₹0.00</span>
                </div>
                <div class="status-item">
                    <span>Win Rate:</span>
                    <span id="todayWinRate" class="text-info">0%</span>
                </div>
                <div class="status-item">
                    <span>Volume:</span>
                    <span id="todayVolume" class="text-warning">₹0</span>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="metric-card">
            <h5><i class="fas fa-clock text-info"></i> Recent Activity</h5>
            <div id="recentActivity" class="mt-3">
                <div class="text-center py-3">
                    <p class="text-muted">No recent activity</p>
                </div>
            </div>
        </div>

        <!-- Position Summary -->
        <div class="metric-card">
            <h5><i class="fas fa-briefcase text-warning"></i> Open Positions</h5>
            <div id="positionSummary" class="mt-3">
                <div class="text-center py-3">
                    <p class="text-muted">No open positions</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="metric-card">
            <h5><i class="fas fa-bolt text-primary"></i> Quick Actions</h5>
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-outline-primary btn-sm" onclick="refreshTrades()">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="exportTrades()">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="showPerformanceModal()">
                    <i class="fas fa-chart-bar"></i> Performance Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsBody">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Performance Modal -->
<div class="modal fade" id="performanceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Performance Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="performanceBody">
                <!-- Performance report will be populated here -->
            </div>
        </div>
    </div>
</div>

<script>
let allTrades = [];
let filteredTrades = [];

// Initialize page
$(document).ready(function() {
    refreshTrades();
    updateStatistics();
    
    // Set today's date as default filter
    $('#dateFilter').val(new Date().toISOString().split('T')[0]);
});

function refreshTrades() {
    // Show loading
    $('#tradesTableBody').html('<tr><td colspan="8" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading trades...</td></tr>');
    
    // In a real implementation, this would fetch from API
    // For now, we'll work with the server-side rendered data
    setTimeout(() => {
        updateStatistics();
        showAlert('success', 'Trade data refreshed');
    }, 1000);
}

function filterTrades() {
    const statusFilter = $('#statusFilter').val();
    const typeFilter = $('#typeFilter').val();
    const dateFilter = $('#dateFilter').val();
    const symbolFilter = $('#symbolFilter').val().toLowerCase();
    
    // Filter the table rows
    $('#tradesTable tbody tr').each(function() {
        const row = $(this);
        const status = row.find('td:nth-child(6) .badge').text().trim();
        const type = row.find('td:nth-child(3) .badge').text().trim();
        const symbol = row.find('td:nth-child(2)').text().toLowerCase();
        const time = row.find('td:nth-child(1)').text();
        
        let show = true;
        
        if (statusFilter && status !== statusFilter) show = false;
        if (typeFilter && type !== typeFilter) show = false;
        if (symbolFilter && !symbol.includes(symbolFilter)) show = false;
        
        row.toggle(show);
    });
    
    updateStatistics();
}

function updateStatistics() {
    // Calculate statistics from visible rows
    let totalTrades = 0;
    let totalPnL = 0;
    let winCount = 0;
    let totalVolume = 0;
    
    $('#tradesTable tbody tr:visible').each(function() {
        const pnlText = $(this).find('td:nth-child(7)').text().replace('₹', '').replace(',', '');
        const priceText = $(this).find('td:nth-child(5)').text().replace('₹', '').replace(',', '');
        const qtyText = $(this).find('td:nth-child(4)').text();
        
        if (pnlText && pnlText !== 'N/A' && !isNaN(parseFloat(pnlText))) {
            totalTrades++;
            const pnl = parseFloat(pnlText);
            totalPnL += pnl;
            if (pnl > 0) winCount++;
            
            const price = parseFloat(priceText) || 0;
            const qty = parseInt(qtyText) || 0;
            totalVolume += price * qty;
        }
    });
    
    const winRate = totalTrades > 0 ? (winCount / totalTrades * 100) : 0;
    
    // Update display
    $('#todayTrades').text(totalTrades);
    $('#todayPnL').text('₹' + totalPnL.toFixed(2)).removeClass('text-success text-danger').addClass(totalPnL >= 0 ? 'text-success' : 'text-danger');
    $('#todayWinRate').text(winRate.toFixed(1) + '%');
    $('#todayVolume').text('₹' + totalVolume.toLocaleString());
}

function viewOrderDetails(orderId) {
    // Show loading in modal
    $('#orderDetailsBody').html('<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
    $('#orderDetailsModal').modal('show');
    
    // Simulate API call to get order details
    setTimeout(() => {
        const detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Order Information</h6>
                    <table class="table table-sm">
                        <tr><td>Order ID:</td><td>${orderId}</td></tr>
                        <tr><td>Exchange:</td><td>NSE</td></tr>
                        <tr><td>Product:</td><td>MIS</td></tr>
                        <tr><td>Order Type:</td><td>MARKET</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Execution Details</h6>
                    <table class="table table-sm">
                        <tr><td>Fill Time:</td><td>${new Date().toLocaleString()}</td></tr>
                        <tr><td>Charges:</td><td>₹15.50</td></tr>
                        <tr><td>Net Amount:</td><td>₹2,485.00</td></tr>
                    </table>
                </div>
            </div>
        `;
        $('#orderDetailsBody').html(detailsHtml);
    }, 500);
}

function exportTrades() {
    // Create CSV content
    let csv = 'Time,Symbol,Type,Quantity,Price,Status,P&L\n';
    
    $('#tradesTable tbody tr:visible').each(function() {
        const row = $(this);
        const time = row.find('td:nth-child(1)').text();
        const symbol = row.find('td:nth-child(2)').text();
        const type = row.find('td:nth-child(3)').text().replace(/\s+/g, ' ').trim();
        const qty = row.find('td:nth-child(4)').text();
        const price = row.find('td:nth-child(5)').text();
        const status = row.find('td:nth-child(6)').text().replace(/\s+/g, ' ').trim();
        const pnl = row.find('td:nth-child(7)').text();
        
        csv += `"${time}","${symbol}","${type}","${qty}","${price}","${status}","${pnl}"\n`;
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showAlert('success', 'Trade data exported successfully');
}

function showPerformanceModal() {
    $('#performanceBody').html('<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Generating report...</div>');
    $('#performanceModal').modal('show');
    
    // Simulate performance report generation
    setTimeout(() => {
        const reportHtml = `
            <div class="row">
                <div class="col-md-4">
                    <div class="metric-card bg-light">
                        <h6>Monthly Performance</h6>
                        <div class="text-center">
                            <h3 class="text-success">+12.5%</h3>
                            <small class="text-muted">This Month</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card bg-light">
                        <h6>Best Day</h6>
                        <div class="text-center">
                            <h3 class="text-success">+₹2,450</h3>
                            <small class="text-muted">Oct 5, 2025</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card bg-light">
                        <h6>Win Rate</h6>
                        <div class="text-center">
                            <h3 class="text-info">68%</h3>
                            <small class="text-muted">Last 30 days</small>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <p class="text-muted text-center">Detailed performance analytics will be available in Phase 3</p>
        `;
        $('#performanceBody').html(reportHtml);
    }, 1000);
}

function showAlert(type, message) {
    // Create alert element
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert alert at top of page
    $('.container-fluid').prepend(alertHtml);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        $('.alert').alert('close');
    }, 3000);
}
</script>
{% endblock %}