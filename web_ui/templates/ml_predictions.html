<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Predictions - Nifty Options Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .ml-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .prediction-card {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .prediction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .confidence-bar {
            height: 20px;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            border-radius: 10px;
            position: relative;
        }
        .confidence-indicator {
            position: absolute;
            width: 3px;
            height: 100%;
            background: #000;
            border-radius: 1px;
        }
        .training-status {
            border-radius: 15px;
            padding: 5px 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-training { background: #fff3cd; color: #856404; }
        .status-ready { background: #d1edff; color: #0c5460; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-robot"></i> ML Predictions
            </a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('dashboard') }}">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('platform_logout') }}">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card ml-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="card-title mb-2">
                                    <i class="bi bi-cpu"></i> Machine Learning Predictions
                                </h2>
                                <p class="card-text mb-0">
                                    Advanced AI-powered price predictions using LSTM neural networks and technical indicators
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button id="trainModelBtn" class="btn btn-light btn-lg">
                                    <i class="bi bi-gear"></i> Train Model
                                </button>
                                <button id="refreshBtn" class="btn btn-outline-light btn-lg ms-2">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Status Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-activity text-primary" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-2">Model Status</h5>
                        <span id="modelStatus" class="training-status status-ready">Ready</span>
                        <div class="mt-2">
                            <small class="text-muted">Loaded Models: <span id="loadedModelsCount">0</span></small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-clock text-info" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-2">Last Updated</h5>
                        <p class="card-text" id="lastUpdated">--:--</p>
                        <div class="mt-2">
                            <small class="text-muted">Cache Size: <span id="cacheSize">0</span></small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-2">Predictions Today</h5>
                        <p class="card-text" id="predictionsCount">0</p>
                        <div class="mt-2">
                            <small class="text-muted">Accuracy: <span id="modelAccuracy">--</span>%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictions Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card prediction-card">
                    <div class="card-header">
                        <h5><i class="bi bi-bullseye"></i> Price Prediction</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h3 id="predictedPrice" class="text-primary">--</h3>
                                <small class="text-muted">Predicted Price</small>
                            </div>
                            <div class="col-6">
                                <h3 id="priceChange" class="text-success">--</h3>
                                <small class="text-muted">Change (%)</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Confidence Level</label>
                            <div class="confidence-bar">
                                <div id="confidenceIndicator" class="confidence-indicator" style="left: 50%;"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small>Low</small>
                                <small id="confidenceValue">50%</small>
                                <small>High</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card prediction-card">
                    <div class="card-header">
                        <h5><i class="bi bi-compass"></i> Trading Signals</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <i id="signalIcon" class="bi bi-dash-circle text-muted" style="font-size: 2rem;"></i>
                                    <div><strong id="signalDirection">NEUTRAL</strong></div>
                                    <small class="text-muted">Signal</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h4 id="signalStrength" class="text-info">--</h4>
                                    <small class="text-muted">Strength</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div id="signalDetails" class="small text-muted">
                                No signals available
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-graph-up"></i> Price Trend</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="priceTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-speedometer"></i> Model Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Controls -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-tools"></i> Model Training & Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="trainingForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="periodDays" class="form-label">Training Period (Days)</label>
                                    <select class="form-select" id="periodDays">
                                        <option value="126">6 Months</option>
                                        <option value="252" selected>1 Year</option>
                                        <option value="504">2 Years</option>
                                        <option value="756">3 Years</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="modelType" class="form-label">Model Type</label>
                                    <select class="form-select" id="modelType">
                                        <option value="lstm" selected>LSTM Neural Network</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="forceRetrain">
                                        <label class="form-check-label" for="forceRetrain">
                                            Force Retrain
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-play"></i> Start Training
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div id="trainingProgress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-2">
                                <small id="trainingStatus">Initializing...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let priceTrendChart = null;
        let performanceChart = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadModelStatus();
            loadPredictions();
            
            // Set up event listeners
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('trainingForm').addEventListener('submit', handleTraining);
            
            // Auto-refresh every 5 minutes
            setInterval(refreshData, 300000);
        });
        
        function initializeCharts() {
            // Price Trend Chart
            const priceTrendCtx = document.getElementById('priceTrendChart').getContext('2d');
            priceTrendChart = new Chart(priceTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Actual Price',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Predicted Price',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderDash: [5, 5],
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Correct Predictions', 'Incorrect Predictions'],
                    datasets: [{
                        data: [75, 25],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function loadModelStatus() {
            fetch('/api/ml/model-status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('loadedModelsCount').textContent = data.loaded_models.length;
                        document.getElementById('cacheSize').textContent = data.cache_size;
                        document.getElementById('lastUpdated').textContent = new Date(data.timestamp).toLocaleTimeString();
                        
                        // Update model status
                        const hasModels = data.loaded_models.length > 0;
                        const statusElement = document.getElementById('modelStatus');
                        statusElement.textContent = hasModels ? 'Ready' : 'No Models';
                        statusElement.className = `training-status ${hasModels ? 'status-ready' : 'status-error'}`;
                        
                        // Update prediction count from inference stats
                        if (data.inference_stats && data.inference_stats.total_predictions) {
                            document.getElementById('predictionsCount').textContent = data.inference_stats.total_predictions;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading model status:', error);
                });
        }
        
        function loadPredictions() {
            fetch('/api/ml/predict-price')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.prediction) {
                        const prediction = data.prediction;
                        
                        // Update prediction display
                        document.getElementById('predictedPrice').textContent = 
                            prediction.prediction_value ? prediction.prediction_value.toFixed(2) : '--';
                        
                        // Update confidence
                        const confidence = prediction.confidence_score * 100;
                        document.getElementById('confidenceValue').textContent = confidence.toFixed(1) + '%';
                        document.getElementById('confidenceIndicator').style.left = confidence + '%';
                        
                        // Update features used info
                        if (prediction.features_used && prediction.features_used.length > 0) {
                            const featuresText = prediction.features_used.slice(0, 3).join(', ');
                            console.log('Features used:', featuresText);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading predictions:', error);
                });
            
            // Load trading signals
            fetch('/api/ml/trading-signals')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.signals) {
                        const signals = data.signals;
                        
                        // Update signal display
                        if (signals.direction) {
                            const direction = signals.direction.toUpperCase();
                            document.getElementById('signalDirection').textContent = direction;
                            
                            // Update signal icon
                            const iconElement = document.getElementById('signalIcon');
                            iconElement.className = `bi ${getSignalIcon(direction)} ${getSignalColor(direction)}`;
                        }
                        
                        if (signals.strength) {
                            document.getElementById('signalStrength').textContent = 
                                (signals.strength * 100).toFixed(0) + '%';
                        }
                        
                        if (signals.details) {
                            document.getElementById('signalDetails').textContent = signals.details;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading trading signals:', error);
                });
        }
        
        function getSignalIcon(direction) {
            switch(direction) {
                case 'BUY':
                case 'BULLISH':
                    return 'bi-arrow-up-circle';
                case 'SELL':
                case 'BEARISH':
                    return 'bi-arrow-down-circle';
                default:
                    return 'bi-dash-circle';
            }
        }
        
        function getSignalColor(direction) {
            switch(direction) {
                case 'BUY':
                case 'BULLISH':
                    return 'text-success';
                case 'SELL':
                case 'BEARISH':
                    return 'text-danger';
                default:
                    return 'text-muted';
            }
        }
        
        function refreshData() {
            loadModelStatus();
            loadPredictions();
        }
        
        function handleTraining(event) {
            event.preventDefault();
            
            const periodDays = document.getElementById('periodDays').value;
            const modelType = document.getElementById('modelType').value;
            const forceRetrain = document.getElementById('forceRetrain').checked;
            
            // Show training progress
            const progressElement = document.getElementById('trainingProgress');
            progressElement.style.display = 'block';
            document.getElementById('trainingStatus').textContent = 'Starting training...';
            
            // Start training
            const params = new URLSearchParams({
                period_days: periodDays,
                model_type: modelType,
                force_retrain: forceRetrain
            });
            
            fetch(`/api/ml/train-model?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('trainingStatus').textContent = 'Training completed successfully!';
                        setTimeout(() => {
                            progressElement.style.display = 'none';
                            refreshData();
                        }, 2000);
                    } else {
                        document.getElementById('trainingStatus').textContent = 'Training failed: ' + data.message;
                    }
                })
                .catch(error => {
                    console.error('Training error:', error);
                    document.getElementById('trainingStatus').textContent = 'Training failed: ' + error.message;
                });
        }
    </script>
</body>
</html>